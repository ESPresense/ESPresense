name: OTA Update Tests

# Uses Wokwi CI for ESP32 emulation and OTA testing
# Wokwi provides full ESP32 hardware emulation with WiFi/network support
# Sign up at https://wokwi.com/ci for a token

on:
  push:
    branches:
      - master
    paths:
      - 'src/Updater.*'
      - 'src/HttpReleaseUpdate*'
      - 'test/test_ota/**'
      - '.github/workflows/ota-tests-wokwi.yml'
  pull_request:
    paths:
      - 'src/Updater.*'
      - 'src/HttpReleaseUpdate*'
      - 'test/test_ota/**'
      - '.github/workflows/ota-tests-wokwi.yml'
  workflow_dispatch:

env:
  WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}

jobs:
  # Build firmware for testing
  build-firmware:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [esp32]
    steps:
      - uses: actions/checkout@v6

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache PlatformIO
        uses: actions/cache@v5
        with:
          path: ~/.platformio/.cache
          key: ${{ runner.os }}-pio

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: |
          pip install wheel
          pip install -U platformio

      - name: Build firmware
        run: pio run -e ${{ matrix.env }}

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v6
        with:
          name: firmware-${{ matrix.env }}
          path: |
            .pio/build/${{ matrix.env }}/firmware.bin
            .pio/build/${{ matrix.env }}/firmware.elf
          retention-days: 7

  # Run actual OTA test in Wokwi simulator
  wokwi-ota-test:
    runs-on: ubuntu-latest
    needs: build-firmware
    steps:
      - uses: actions/checkout@v6

      - name: Download firmware artifact
        uses: actions/download-artifact@v7
        with:
          name: firmware-esp32
          path: ./firmware

      - name: Setup test firmware server
        run: |
          # Create a simple HTTP server to serve the firmware for OTA
          mkdir -p test-server
          cp ./firmware/firmware.bin test-server/esp32.bin

          # Start HTTP server in background
          cd test-server
          python3 -m http.server 8080 &
          echo $! > /tmp/http_server.pid
          cd ..

          sleep 2
          echo "Test firmware server running on http://localhost:8080/esp32.bin"

      - name: Check Wokwi token availability
        id: check_token
        run: |
          if [ -n "${{ secrets.WOKWI_CLI_TOKEN }}" ]; then
            echo "token_available=true" >> $GITHUB_OUTPUT
            echo "✓ Wokwi CI token is configured"
          else
            echo "token_available=false" >> $GITHUB_OUTPUT
            echo "⚠️  Wokwi CI token not configured - skipping emulation test"
            echo "ℹ️  To enable Wokwi CI testing, add WOKWI_CLI_TOKEN to repository secrets"
          fi

      - name: Run Wokwi CI OTA Test
        if: steps.check_token.outputs.token_available == 'true'
        uses: wokwi/wokwi-ci-action@v1
        with:
          token: ${{ secrets.WOKWI_CLI_TOKEN }}
          path: / # Run from project root
          timeout: 300000 # 5 minutes in milliseconds
          expect_text: "Update OK"
          fail_text: "Update Failed"
          scenario: test/scenarios/ota-test.yaml

      - name: Verify OTA test results
        if: steps.check_token.outputs.token_available == 'true'
        run: |
          echo "✓ Wokwi CI OTA test completed"
          echo "Check logs above for detailed results"

      - name: Cleanup
        if: always()
        run: |
          # Kill HTTP server if running
          if [ -f /tmp/http_server.pid ]; then
            kill $(cat /tmp/http_server.pid) 2>/dev/null || true
          fi

  # GitHub connectivity test (always runs for validation)
  github-connectivity-test:
    runs-on: ubuntu-latest
    needs: build-firmware
    steps:
      - uses: actions/checkout@v6

      - name: Test GitHub releases endpoint
        run: |
          echo "Testing GitHub releases endpoint..."

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -L \
            -H "Accept: application/octet-stream" \
            "https://github.com/ESPresense/ESPresense/releases/latest/download/esp32.bin")

          echo "HTTP Response Code: $RESPONSE"

          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 302 ] || [ "$RESPONSE" -eq 301 ]; then
            echo "✓ GitHub releases endpoint is accessible via HTTPS"
          else
            echo "✗ Unexpected response code: $RESPONSE"
            exit 1
          fi

      - name: Test SSL and rate limits
        run: |
          echo "Testing SSL certificate for github.com..."
          echo | openssl s_client -connect github.com:443 -servername github.com 2>&1 | \
            grep -q "Verify return code: 0 (ok)" && \
            echo "✓ SSL certificate is valid" || \
            echo "⚠ SSL certificate validation failed"

          echo "Checking GitHub API rate limit headers..."
          curl -s -I "https://api.github.com/repos/ESPresense/ESPresense/releases/latest" | \
            grep -i "x-ratelimit" || echo "No rate limit headers found"

  # Summary report
  test-summary:
    runs-on: ubuntu-latest
    needs: [build-firmware, wokwi-ota-test, github-connectivity-test]
    if: always()
    steps:
      - name: Generate test summary
        run: |
          echo "## OTA Update Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Firmware Build: ${{ needs.build-firmware.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Wokwi OTA Integration Test: ${{ needs.wokwi-ota-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Connectivity Test: ${{ needs.github-connectivity-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-firmware.result }}" == "success" ] && \
             [ "${{ needs.wokwi-ota-test.result }}" == "success" ] && \
             [ "${{ needs.github-connectivity-test.result }}" == "success" ]; then
            echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some tests failed - review above**" >> $GITHUB_STEP_SUMMARY
          fi
